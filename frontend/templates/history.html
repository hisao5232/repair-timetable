<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ä¿®ç†å±¥æ­´æ¤œç´¢ - Repair-Time</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .search-box { margin-bottom: 20px; display: flex; gap: 10px; }
        .search-box input { flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #ccc; }
        .history-table { width: 100%; border-collapse: collapse; background: #fff; font-size: 0.9em; }
        .history-table th, .history-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .history-table th { background: #f4f4f4; position: sticky; top: 0; }
        .history-table tr:hover { background: #f9f9f9; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header-bar">
            <div><strong>ğŸ” ä¿®ç†å±¥æ­´æ¤œç´¢</strong></div>
            <a href="/" class="logout-btn" style="background: #6c757d;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æˆ»ã‚‹</a>
        </header>

        <div class="search-box">
            <input type="text" id="search-input" placeholder="é¡§å®¢åã€å‹å¼ã€ç¾å ´åãªã©ã§æ¤œç´¢..." oninput="filterHistory()">
        </div>

        <table class="history-table">
            <thead>
                <tr>
                    <th>æ—¥æ™‚</th>
                    <th>é¡§å®¢å</th>
                    <th>å‹å¼</th>
                    <th>ç¾å ´</th>
                    <th>ä½œæ¥­è€…</th>
                    <th>ä½œæ¥­å†…å®¹</th>
                </tr>
            </thead>
            <tbody id="history-list">
                </tbody>
        </table>
    </div>

    <script>
        let allAppointments = [];

        async function loadHistory() {
            try {
                const response = await fetch('https://repair-api.go-pro-world.net/appointments');
                allAppointments = await response.json();
                // æ—¥æ™‚ãŒæ–°ã—ã„é †ã«ä¸¦ã³æ›¿ãˆ
                allAppointments.sort((a, b) => new Date(b.appointment_date) - new Date(a.appointment_date));
                displayHistory(allAppointments);
            } catch (e) { console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:', e); }
        }

        function displayHistory(data) {
            const list = document.getElementById('history-list');
            list.innerHTML = data.map(app => `
                <tr>
                    <td>${app.appointment_date.split('T')[0]}</td>
                    <td><strong>${app.customer_name}</strong></td>
                    <td>${app.machine_model}</td>
                    <td>${app.location}</td>
                    <td>${app.worker_name || '-'}</td>
                    <td><small>${app.completion_notes || '-'}</small></td>
                </tr>
            `).join('');
        }

        function filterHistory() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filtered = allAppointments.filter(app => 
                app.customer_name.toLowerCase().includes(query) ||
                app.machine_model.toLowerCase().includes(query) ||
                app.location.toLowerCase().includes(query) ||
                (app.completion_notes && app.completion_notes.toLowerCase().includes(query))
            );
            displayHistory(filtered);
        }

        document.addEventListener('DOMContentLoaded', loadHistory);
    </script>
</body>
</html>
