<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ä¿®ç†å±¥æ­´æ¤œç´¢ - Repair-Time</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .search-box { margin-bottom: 20px; display: flex; gap: 10px; }
        .search-box input { flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #ccc; }
        .history-table { width: 100%; border-collapse: collapse; background: #fff; font-size: 0.9em; }
        .history-table th, .history-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .history-table th { background: #f4f4f4; position: sticky; top: 0; }
        .history-table tr:hover { background: #f9f9f9; }
        .detail-btn { background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆindex.htmlã‹ã‚‰ç§»æ¤ï¼‰ */
        .modal-field-group { margin-bottom: 12px; }
        .modal-field-group label { display: block; font-size: 0.8em; color: #666; margin-bottom: 2px; }
        .modal-field-group input, .modal-field-group textarea { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; }
        .checkbox-group label { background: #fff; border: 1px solid #ddd; padding: 5px 10px; border-radius: 20px; font-size: 0.85em; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .checkbox-group input { width: auto; }
        #status-modal { max-height: 90vh; overflow-y: auto; display:none; background: #fff; border: 1px solid #000; padding: 20px; position: fixed; top: 5%; left: 50%; transform: translateX(-50%); z-index: 1000; box-shadow: 0 4px 25px rgba(0,0,0,0.4); border-radius: 8px; width: 95%; max-width: 480px; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header-bar" style="display: flex; justify-content: space-between; align-items: center; background: #333; color: white; padding: 10px 20px; border-radius: 4px; margin-bottom: 20px;">
            <div><strong>ğŸ” ä¿®ç†å±¥æ­´æ¤œç´¢</strong></div>
            <a href="/" style="background: #6c757d; color: white; text-decoration: none; padding: 5px 15px; border-radius: 4px; font-size: 0.9em;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æˆ»ã‚‹</a>
        </header>

        <div class="search-box">
            <input type="text" id="search-input" placeholder="é¡§å®¢åã€å‹å¼ã€ç¾å ´åãªã©ã§æ¤œç´¢..." oninput="filterHistory()">
        </div>

        <table class="history-table">
            <thead>
                <tr>
                    <th>æ—¥æ™‚</th>
                    <th>é¡§å®¢å</th>
                    <th>å‹å¼</th>
                    <th>ç¾å ´</th>
                    <th>ä½œæ¥­è€…</th>
                    <th>è©³ç´°</th>
                </tr>
            </thead>
            <tbody id="history-list"></tbody>
        </table>
    </div>

    <div id="status-modal">
        <h3 style="margin-top:0;">ğŸ“ äºˆå®šã®è©³ç´°ãƒ»ä¿®æ­£</h3>
        <input type="hidden" id="modal-app-id">
        
        <div class="modal-grid">
            <div class="modal-field-group">
                <label>é¡§å®¢å</label>
                <input type="text" id="edit_customer_name">
            </div>
            <div class="modal-field-group">
                <label>æ‹…å½“è€…</label>
                <input type="text" id="edit_contact_person">
            </div>
            <div class="modal-field-group">
                <label>é€£çµ¡å…ˆ</label>
                <input type="text" id="edit_phone_number">
            </div>
            <div class="modal-field-group">
                <label>æ—¥æ™‚</label>
                <input type="datetime-local" id="edit_appointment_date">
                <label style="font-size: 0.8em; color: #666; cursor: pointer; display: block; margin-top: 4px;">
                    <input type="checkbox" id="edit_no_time_specified"> æ™‚é–“æŒ‡å®šãªã—
                </label>
            </div>
            <div class="modal-field-group">
                <label>å—ä»˜æ‹…å½“</label>
                <input type="text" id="edit_received_by">
            </div>
            <div class="modal-field-group">
                <label style="cursor: pointer;">
                    <input type="checkbox" id="edit_is_own_lease" onchange="toggleLeaseLocation('edit')"> è‡ªç¤¾ãƒªãƒ¼ã‚¹æ©Ÿ
                </label>
                <select id="edit_lease_location" style="display: none; width: 100%; margin-top: 5px; padding: 8px;">
                    <option value="">æ‹ ç‚¹ã‚’é¸æŠ</option>
                    <option value="ç”ºç”°">ç”ºç”°</option>
                    <option value="åšæœ¨">åšæœ¨</option>
                    <option value="ç›¸æ¨¡åŸ">ç›¸æ¨¡åŸ</option>
                    <option value="å¤§å’Œ">å¤§å’Œ</option>
                    <option value="å·¥å ´">å·¥å ´</option>
                    <option value="åŒè‘‰">åŒè‘‰</option>
                </select>
            </div>
            <div class="modal-field-group">
                <label>å‹å¼</label>
                <input type="text" id="edit_machine_model">
            </div>
            <div class="modal-field-group">
                <label>ã‚·ãƒªã‚¢ãƒ« No</label>
                <input type="text" id="edit_serial_number">
            </div>
        </div>

        <div class="modal-field-group">
            <label>ç¾å ´ä½æ‰€</label>
            <input type="text" id="edit_location">
        </div>
        <div class="modal-field-group">
            <label>æ•…éšœç—‡çŠ¶ãƒ»ãƒ¡ãƒ¢</label>
            <textarea id="edit_failure_symptoms" style="height: 60px;"></textarea>
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
        
        <h4 style="margin: 0 0 10px 0;">âœ… ä¿®ç†å®Œäº†å ±å‘Š</h4>
        
        <div class="modal-field-group">
            <label>æ•…éšœåŸå› ã‚«ãƒ†ã‚´ãƒªãƒ¼ (è¤‡æ•°é¸æŠå¯)</label>
            <div class="checkbox-group" id="modal-category-group">
                <label><input type="checkbox" value="ç‡ƒæ–™ç³»"> ç‡ƒæ–™ç³»</label>
                <label><input type="checkbox" value="é›»æ°—ç³»"> é›»æ°—ç³»</label>
                <label><input type="checkbox" value="æ²¹åœ§ç³»"> æ²¹åœ§ç³»</label>
                <label><input type="checkbox" value="æ§‹é€ ç³»"> æ§‹é€ ç³»</label>
                <label><input type="checkbox" value="å®šæœŸç‚¹æ¤œ"> å®šæœŸç‚¹æ¤œ</label>
                <label><input type="checkbox" value="å…ˆæ–¹éƒ½åˆ"> å…ˆæ–¹éƒ½åˆ</label>
            </div>
        </div>

        <div class="modal-field-group">
            <input type="text" id="worker_name" placeholder="ä½œæ¥­è€…å (ä¾‹ : è‡ªåˆ†ã®åå‰)">
        </div>
        <div class="modal-field-group">
            <textarea id="completion_notes" placeholder="äº¤æ›éƒ¨å“ã‚„ä½œæ¥­å†…å®¹ã®å‚™è€ƒ" style="height: 60px;"></textarea>
        </div>

        <div style="display: flex; flex-direction: column; gap: 8px;">
            <button onclick="submitCompletion()" style="background-color: #28a745; color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1em;">å†…å®¹ã‚’æ›´æ–° / å®Œäº†ã¨ã—ã¦ä¿å­˜</button>
            <div style="display: flex; gap: 8px;">
                <button onclick="deleteAppointment()" style="flex: 1; background-color: white; color: #d9534f; border: 1px solid #d9534f; padding: 10px; border-radius: 4px; cursor: pointer;">ã“ã®äºˆç´„ã‚’å‰Šé™¤</button>
                <button onclick="closeModal()" style="flex: 1; background-color: #6c757d; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer;">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        let allAppointments = [];
        async function loadHistory() {
            try {
                const response = await fetch('https://repair-api.go-pro-world.net/appointments');
                allAppointments = await response.json();
                allAppointments.sort((a, b) => new Date(b.appointment_date) - new Date(a.appointment_date));
                displayHistory(allAppointments);
            } catch (e) { console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:', e); }
        }

        function displayHistory(data) {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            data.forEach(app => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${app.appointment_date.replace('T', ' ')}</td>
                    <td><strong>${app.customer_name}</strong></td>
                    <td>${app.machine_model}</td>
                    <td>${app.location}</td>
                    <td>${app.worker_name || '-'}</td>
                    <td><button class="detail-btn" onclick='openCompletionModal(${JSON.stringify(app)})'>è©³ç´°</button></td>
                `;
                list.appendChild(tr);
            });
        }

        function filterHistory() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filtered = allAppointments.filter(app =>
                app.customer_name.toLowerCase().includes(query) ||
                app.machine_model.toLowerCase().includes(query) ||
                app.location.toLowerCase().includes(query) ||
                (app.completion_notes && app.completion_notes.toLowerCase().includes(query))
            );
            displayHistory(filtered);
        }
        document.addEventListener('DOMContentLoaded', loadHistory);
    </script>
</body>
</html>
